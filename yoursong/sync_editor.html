<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Perfect Sync Editor | Your Song</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #player-wrapper { width: 80%; max-width: 800px; margin-bottom: 20px; }
        audio { width: 100%; }
        #lyrics-display { font-size: 2em; margin: 20px 0; font-weight: bold; min-height: 1.5em; }
        #lyrics-display .highlight { color: #fff; background-color: #007bff; padding: 5px 10px; border-radius: 5px; }
        #output-area { width: 80%; max-width: 800px; }
        textarea { width: 100%; height: 200px; margin-top: 10px; font-family: monospace; }
        button { font-size: 1.2em; padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Perfect Sync Editor</h1>
    <div id="player-wrapper">
        <audio id="audioPlayer" controls src="your_song.mp3"></audio>
    </div>
    <button id="startButton">Start Sync</button>
    <div id="lyrics-display">Press "Start Sync" to begin...</div>
    <div id="output-area">
        <h3>Generated Data:</h3>
        <textarea id="outputJson" readonly placeholder="Your perfect sync data will appear here..."></textarea>
    </div>

    <script>
    const audioPlayer = document.getElementById('audioPlayer');
    const startButton = document.getElementById('startButton');
    const lyricsDisplay = document.getElementById('lyrics-display');
    const outputJson = document.getElementById('outputJson');

    const rawLyrics = [
        "It's a little bit funny",
        "This feelin' inside",
        "I'm not one of those who can easily hide",
        "I don't have much money, but boy, if I did",
        "I'd buy a big house where we both could live",
        "If I was a sculptor, heh",
        "But then again, no",
        "Or a man who makes potions in a travellin' show, oh",
        "I know it's not much, but it's the best I can do",
        "My gift is my song and this one's for you",
        "And you can tell everybody",
        "This is your song",
        "It may be quite simple, but",
        "Now that it's done",
        "I hope you don't mind, I hope you don't mind",
        "That I put down in words",
        "How wonderful life is",
        "While you're in the world",
        "I sat on the roof",
        "And kicked off the moss",
        "Well, a few of the verses",
        "Well, they've got me quite cross",
        "But the sun's been quite kind",
        "While I wrote this song",
        "It's for people like you that keep it turned on",
        "So excuse me forgettin'",
        "But these things I do",
        "You see, I've forgotten",
        "If they're green or they're blue",
        "Anyway, the thing is",
        "What I really mean",
        "Yours are the sweetest eyes I've ever seen",
        "And you can tell everybody",
        "This is your song",
        "It may be quite simple, but",
        "Now that it's done",
        "I hope you don't mind, I hope you don't mind",
        "That I put down in words",
        "How wonderful life is",
        "While you're in the world",
        "I hope you don't mind, I hope you don't mind",
        "That I put down in words",
        "How wonderful life is",
        "While you're in the world"
    ];

    let allWords = [];
    rawLyrics.forEach(line => {
        line.split(' ').forEach(word => {
            if (word) allWords.push(word);
        });
    });

    let currentWordIndex = 0;
    let timingData = [];

    function startSync() {
        currentWordIndex = 0;
        timingData = [];
        audioPlayer.currentTime = 0;
        audioPlayer.play();
        updateDisplay();
        document.body.onkeydown = handleKeyPress;
        startButton.disabled = true;
    }

    function handleKeyPress(e) {
        if (e.code === 'Space' && currentWordIndex < allWords.length) {
            e.preventDefault();
            timingData.push({ time: audioPlayer.currentTime, text: allWords[currentWordIndex] });
            currentWordIndex++;
            updateDisplay();

            if (currentWordIndex === allWords.length) {
                finishSync();
            }
        }
    }

    function updateDisplay() {
        if (currentWordIndex < allWords.length) {
            lyricsDisplay.innerHTML = `Press SPACE for: <span class="highlight">${allWords[currentWordIndex]}</span>`;
        } else {
            lyricsDisplay.textContent = "All Done!";
        }
    }
    
    function finishSync() {
        document.body.onkeydown = null;
        startButton.disabled = false;
        generateJsonOutput();
    }

    function generateJsonOutput() {
        let finalData = [];
        let lineIndex = 0;
        let wordCountInLine = 0;
        
        const lineWordCounts = rawLyrics.map(line => line.split(' ').filter(w => w).length);

        finalData.push({ words: [] });

        timingData.forEach((wordData, i) => {
            let endTime;
            if (i < timingData.length - 1) {
                endTime = timingData[i + 1].time - 0.01; // Next word's start time is this word's end time
            } else {
                endTime = wordData.time + 1.0; // Last word duration
            }
            
            finalData[lineIndex].words.push({
                startTime: parseFloat(wordData.time.toFixed(2)),
                endTime: parseFloat(endTime.toFixed(2)),
                text: wordData.text + " "
            });

            wordCountInLine++;
            if (wordCountInLine >= lineWordCounts[lineIndex]) {
                // Strip space from last word of the line
                let lastWord = finalData[lineIndex].words[finalData[lineIndex].words.length - 1];
                lastWord.text = lastWord.text.trim();

                lineIndex++;
                wordCountInLine = 0;
                if(lineIndex < lineWordCounts.length) {
                    finalData.push({ words: [] });
                }
            }
        });

        let outputString = "const lyricsDataWithWords = [\n";
        finalData.forEach(line => {
            outputString += "    { words: [ ";
            line.words.forEach(word => {
                outputString += `{ startTime: ${word.startTime}, endTime: ${word.endTime}, text: "${word.text}" }, `;
            });
            outputString = outputString.slice(0, -2); // remove last comma and space
            outputString += " ] },\n";
        });
        outputString = outputString.slice(0, -2); // remove last comma and newline
        outputString += "\n];";

        outputJson.value = outputString;
    }

    startButton.onclick = startSync;
    audioPlayer.onended = finishSync;

    </script>
</body>
</html>