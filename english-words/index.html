<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Learning Site</title>
    <!-- Bootstrap 5.3.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 6.6.0 -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap 5.3.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container-md">
            <a class="navbar-brand fw-bold" href="#"><i class="fas fa-book-open me-2"></i>Vocab Fun</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active rounded px-3" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link rounded px-3" href="quiz.html">Quiz</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-md my-5">
        <h1 class="text-center mb-4 fw-bold">Vocabulary Cards</h1>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4" id="cardContainer"></div>
    </div>

    <script>
        $(document).ready(function() {
            // Fallback data (10 words)
            const fallbackWords = [
                {word: "red", meaning: "赤", category: "color", icon: "fas fa-circle", color: "red", background: "bg-color"},
                {word: "blue", meaning: "青", category: "color", icon: "fas fa-circle", color: "blue", background: "bg-color"},
                {word: "apple", meaning: "りんご", category: "fruit", icon: "fas fa-apple-alt", background: "bg-fruit"},
                {word: "dog", meaning: "犬", category: "animal", icon: "fas fa-dog", background: "bg-animal"},
                {word: "run", meaning: "走る", category: "action", icon: "fas fa-running", background: "bg-action"},
                {word: "happy", meaning: "幸せ", category: "emotion", icon: "fas fa-smile", background: "bg-emotion"},
                {word: "school", meaning: "学校", category: "school", icon: "fas fa-school", background: "bg-school"},
                {word: "sun", meaning: "太陽", category: "weather", icon: "fas fa-sun", background: "bg-weather"},
                {word: "one", meaning: "一", category: "number", icon: "fas fa-1", background: "bg-number"},
                {word: "home", meaning: "家", category: "place", icon: "fas fa-home", background: "bg-place"}
            ];

            // Debounce function
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            // Filter voices
            function filterVoices(voices) {
                const allowedLangs = ['en-US', 'en-GB', 'ja-JP'];
                return voices.filter(voice => allowedLangs.includes(voice.lang));
            }

            // Speak word function
            function speakWord(word, retryCount = 0, maxRetries = 3) {
                console.log(`Attempting to speak: ${word}, Retry: ${retryCount}`);
                console.log(`Speech state - Pending: ${speechSynthesis.pending}, Speaking: ${speechSynthesis.speaking}, Paused: ${speechSynthesis.paused}`);
                
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US'; // Chrome/iOSで安定
                const voices = filterVoices(speechSynthesis.getVoices());
                console.log(`Filtered voices (${voices.length}):`, voices.map(v => `${v.name} (${v.lang})`));
                const selectedVoice = voices.find(voice => voice.lang === 'en-US') ||
                                     voices.find(voice => voice.lang === 'en-GB') ||
                                     voices[0];
                if (!selectedVoice) {
                    console.warn('No voices available');
                    alert('No speech synthesis voices available. Check browser sound settings (e.g., iOS: Settings > Sounds, Windows: Sound Settings, macOS: System Settings > Sound).');
                    return;
                }
                utterance.voice = selectedVoice;
                console.log(`Using voice: ${selectedVoice.name} (${selectedVoice.lang})`);

                utterance.onstart = () => console.log(`Started speaking: ${word}`);
                utterance.onend = () => console.log(`Finished speaking: ${word}`);
                utterance.onerror = (e) => {
                    console.error(`Speech error: ${e.error}, Message: ${e.error?.message || 'none'}, Word: ${word}`);
                    if ((e.error === 'interrupted' || e.error === 'canceled') && retryCount < maxRetries) {
                        console.log(`Retrying (${retryCount + 1}/${maxRetries}) after 300ms`);
                        setTimeout(() => speakWord(word, retryCount + 1, maxRetries), 300);
                    } else if (retryCount === maxRetries) {
                        console.warn(`Max retries reached for: ${word}`);
                        alert(`Failed to speak "${word}" after ${maxRetries} attempts. Check sound settings (iOS: Settings > Sounds, Windows: chrome://settings/content/sound, macOS: System Settings > Sound) or try another browser.`);
                    }
                };

                // Clear queue and resume
                speechSynthesis.cancel();
                speechSynthesis.resume();
                speechSynthesis.speak(utterance);
            }

            // Bind card events with debounce
            const debouncedSpeak = debounce((word) => {
                speakWord(word);
            }, 300);

            function bindCardEvents() {
                $('.vocab-card').off('click touchstart').on('click', function(e) {
                    e.preventDefault();
                    const word = $(this).data('word');
                    console.log(`Click event on card: ${word}`);
                    debouncedSpeak(word);
                }).on('touchstart', function(e) {
                    e.preventDefault();
                    const word = $(this).data('word');
                    console.log(`Touchstart event on card: ${word}`);
                    debouncedSpeak(word);
                });
            }

            // Render cards
            function renderCards(words) {
                const cardContainer = $('#cardContainer');
                cardContainer.empty();
                words.forEach(word => {
                    const iconStyle = word.color ? `style="color: ${word.color}"` : '';
                    const card = `
                        <div class="col mb-4">
                            <div class="card vocab-card shadow-sm ${word.background}" data-word="${word.word}">
                                <div class="card-body text-center">
                                    <i class="${word.icon} mb-2 fa-2x" ${iconStyle}></i>
                                    <h5 class="card-title fw-bold">${word.word}</h5>
                                    <p class="card-text">${word.meaning}</p>
                                </div>
                            </div>
                        </div>`;
                    cardContainer.append(card);
                });
                bindCardEvents();
            }

            // Load JSON
            fetch('./kidswords.json')
                .then(response => {
                    if (!response.ok) throw new Error(`Failed to load kidswords.json: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    renderCards(data);
                    // Initialize speech synthesis
                    function initializeSpeech() {
                        const voices = filterVoices(speechSynthesis.getVoices());
                        console.log(`Filtered voices loaded (${voices.length}):`, voices.map(v => `${v.name} (${v.lang})`));
                        if (voices.length) {
                            bindCardEvents();
                        } else {
                            console.warn('No filtered voices loaded');
                            alert('Speech synthesis voices not loaded. Try refreshing or check browser settings.');
                        }
                    }

                    if (speechSynthesis.getVoices().length) {
                        initializeSpeech();
                    } else {
                        speechSynthesis.onvoiceschanged = () => {
                            console.log('Voices changed event fired');
                            initializeSpeech();
                        };
                        setTimeout(() => {
                            console.log('Fallback voice check after 3s');
                            if (speechSynthesis.getVoices().length) {
                                initializeSpeech();
                            }
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error loading JSON:', error);
                    alert('Failed to load vocabulary data. Using fallback data.');
                    renderCards(fallbackWords);
                });

            // Ensure speech synthesis is initialized on user interaction
            document.addEventListener('click', () => {
                console.log('User interaction detected, resuming speech synthesis');
                speechSynthesis.cancel();
                speechSynthesis.resume();
            }, { once: true });
        });
    </script>
</body>
</html>