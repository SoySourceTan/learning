<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Learning Site</title>
    <!-- Bootstrap 5.3.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 6.6.0 -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap 5.3.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .vocab-card {
            min-height: 120px;
            max-height: 150px;
            overflow: hidden;
        }
        .vocab-icon {
            transition: transform 0.3s ease;
        }
        .vocab-icon-spin {
            animation: spin 0.5s ease-in-out;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-title {
            font-size: 1rem;
        }
        .card-text {
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container-md">
            <a class="navbar-brand fw-bold" href="#"><i class="fas fa-book-open me-2"></i>Vocab Fun</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active rounded px-3" href="index.php">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link rounded px-3" href="quiz.html">Quiz</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-md my-4">
        <h1 class="text-center mb-4 fw-bold">Vocabulary Cards</h1>
        <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-6 g-2" id="cardContainer"></div>
    </div>

    <script>
        $(document).ready(function() {
            // Fallback words
            const fallbackWords = [
                {word: "red", meaning: "赤", category: "color", icon: "fas fa-circle", color: "red", background: "bg-color"},
                {word: "blue", meaning: "青", category: "color", icon: "fas fa-circle", color: "blue", background: "bg-color"},
                {word: "apple", meaning: "りんご", category: "fruit", icon: "fas fa-apple-alt", background: "bg-fruit"},
                {word: "dog", meaning: "犬", category: "animal", icon: "fas fa-dog", background: "bg-animal"},
                {word: "run", meaning: "走る", category: "action", icon: "fas fa-running", background: "bg-action"},
                {word: "happy", meaning: "幸せ", category: "emotion", icon: "fas fa-smile", background: "bg-emotion"},
                {word: "school", meaning: "学校", category: "school", icon: "fas fa-school", background: "bg-school"},
                {word: "sun", meaning: "太陽", category: "weather", icon: "fas fa-sun", background: "bg-weather"},
                {word: "one", meaning: "一", category: "number", icon: "fas fa-1", background: "bg-number"},
                {word: "home", meaning: "家", category: "place", icon: "fas fa-home", background: "bg-place"}
            ];

            // Default category icons
            const defaultIcons = {
                'color': 'fas fa-palette',
                'vegetable': 'fas fa-carrot',
                'fruit': 'fas fa-apple-alt',
                'shape': 'fas fa-shapes',
                'body': 'fas fa-user',
                'object': 'fas fa-pencil-alt',
                'animal': 'fas fa-paw',
                'weather': 'fas fa-cloud',
                'number': 'fas fa-sort-numeric-up',
                'place': 'fas fa-map-marker-alt',
                'action': 'fas fa-running',
                'time': 'fas fa-clock',
                'school': 'fas fa-school',
                'emotion': 'fas fa-smile',
                'fish': 'fas fa-fish',
                'meat': 'fas fa-drumstick-bite',
                'soy': 'fas fa-seedling'
            };

            // Speak word function (unchanged)
            function speakWord(word) {
                console.log(`Attempting to speak: ${word}`);
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-GB';
                const voices = speechSynthesis.getVoices();
                const selectedVoice = voices.find(voice => voice.lang === 'en-GB') ||
                                     voices.find(voice => voice.lang === 'en-US') ||
                                     voices[0];
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                    console.log(`Using voice: ${selectedVoice.name} (${selectedVoice.lang})`);
                } else {
                    console.warn('No voices available');
                    alert('No speech synthesis voices available. Please check your browser settings.');
                    return;
                }
                utterance.onstart = () => console.log(`Started speaking: ${word}`);
                utterance.onend = () => console.log(`Finished speaking: ${word}`);
                utterance.onerror = (e) => {
                    console.error(`Speech error: ${e.error}`);
                    if (e.error === 'interrupted') {
                        setTimeout(() => speechSynthesis.speak(utterance), 100);
                    }
                };
                speechSynthesis.cancel();
                speechSynthesis.speak(utterance);
            }

            // Bind card events
            function bindCardEvents() {
                $('.vocab-card').off('click touchstart').on('click', function(e) {
                    e.preventDefault();
                    const word = $(this).data('word');
                    console.log(`Click event on card: ${word}`);
                    $(this).find('.vocab-icon').addClass('vocab-icon-spin');
                    setTimeout(() => $(this).find('.vocab-icon').removeClass('vocab-icon-spin'), 500);
                    speakWord(word);
                }).on('touchstart', function(e) {
                    e.preventDefault();
                    const word = $(this).data('word');
                    console.log(`Touchstart event on card: ${word}`);
                    $(this).find('.vocab-icon').addClass('vocab-icon-spin');
                    setTimeout(() => $(this).find('.vocab-icon').removeClass('vocab-icon-spin'), 500);
                    speakWord(word);
                });
            }

            // Render cards
            function renderCards(words) {
                const cardContainer = $('#cardContainer');
                cardContainer.empty();
                words.forEach(word => {
                    const icon = word.icon || defaultIcons[word.category] || 'fas fa-question';
                    const iconStyle = word.color ? `style="color: ${word.color}"` : '';
                    const card = `
                        <div class="col">
                            <div class="card vocab-card shadow-sm ${word.background || 'bg-light'}" data-word="${word.word}">
                                <div class="card-body text-center p-2">
                                    <i class="vocab-icon ${icon} mb-1 fa-lg" ${iconStyle}></i>
                                    <h6 class="card-title fw-bold mb-1">${word.word}</h6>
                                    <p class="card-text">${word.meaning}</p>
                                </div>
                            </div>
                        </div>`;
                    cardContainer.append(card);
                });
                bindCardEvents();
            }

            // Load JSON
            fetch('./kidswords.json')
                .then(response => {
                    if (!response.ok) throw new Error(`Failed to load kidswords.json: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    renderCards(data);
                    function initializeSpeech() {
                        const voices = speechSynthesis.getVoices();
                        console.log('Voices loaded:', voices.map(v => `${v.name} (${v.lang})`));
                        if (voices.length) {
                            bindCardEvents();
                        } else {
                            console.warn('No voices loaded yet');
                            alert('Speech synthesis voices not available. Please try refreshing the page or check your browser settings.');
                        }
                    }

                    if (speechSynthesis.getVoices().length) {
                        initializeSpeech();
                    } else {
                        speechSynthesis.onvoiceschanged = initializeSpeech;
                        setTimeout(() => {
                            if (speechSynthesis.getVoices().length) {
                                initializeSpeech();
                            }
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error loading JSON:', error);
                    alert('Failed to load vocabulary data. Using fallback data.');
                    renderCards(fallbackWords);
                });
        });
    </script>
</body>
</html>
