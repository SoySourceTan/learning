window.isInitialized = false;

$(document).ready(function() {
    if (window.isInitialized) {
        console.log('quiz.js Êó¢„Å´ÂàùÊúüÂåñÊ∏à„Åø„ÄÅ„Çπ„Ç≠„ÉÉ„Éó');
        return;
    }
    window.isInitialized = true;
    console.log('quiz.js „É≠„Éº„ÉâÈñãÂßã');
    let currentQuestion = 0;
    let score = 0;
    let totalQuestions = 0;
    let currentLevel = 1;
    let currentSet = 1;
    let correctInCurrentSet = 0;
    const QUESTIONS_PER_SET = 5;
    let lastClick = 0;

    function generateQuestion() {
        console.log(`„ÇØ„Ç§„Ç∫ÁîüÊàêÈñãÂßã: currentQuestion=${currentQuestion}, words.length=${window.words.length}`);
        if (window.words.length === 0) {
            console.warn('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Éá„Éï„Ç©„É´„Éà„Éá„Éº„Çø„Çí‰ΩøÁî®„ÄÇ');
            showToast('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Éá„Éï„Ç©„É´„Éà„Éá„Éº„Çø„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ', 'error');
            window.words = fallbackWords.sort(() => Math.random() - 0.5);
        }
        if (currentQuestion >= window.words.length) {
            console.log('„ÇØ„Ç§„Ç∫ÁµÇ‰∫Ü');
            $('#quizContainer').html(`<h3 class="text-center">„ÇØ„Ç§„Ç∫„ÅåÁµÇ„Çè„Çä„Åæ„Åó„ÅüÔºÅÊúÄÁµÇ„Çπ„Ç≥„Ç¢: ${score}/${totalQuestions} (Level ${currentLevel})</h3>`);
            return;
        }

        const question = window.words[currentQuestion];
        console.log('ÁèæÂú®„ÅÆÂïèÈ°å:', question);
        if (!question || !question.word) {
            console.error('ÁÑ°Âäπ„Å™ÂïèÈ°å„Éá„Éº„Çø:', question);
            showToast('ÂïèÈ°å„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊ¨°„Å∏ÈÄ≤„Åø„Åæ„Åô„ÄÇ', 'error');
            currentQuestion++;
            generateQuestion();
            return;
        }

        const correctAnswer = question.ruby || question.meaning;
        const wrongAnswers = [];
        const usedMeanings = new Set([question.meaning]);
        const sameCategoryWords = window.words.filter(w => w.category === question.category && w.meaning !== question.meaning);
        while (wrongAnswers.length < 3 && sameCategoryWords.length > 0) {
            const randomIndex = Math.floor(Math.random() * sameCategoryWords.length);
            const randomWord = sameCategoryWords[randomIndex];
            if (!usedMeanings.has(randomWord.meaning)) {
                wrongAnswers.push(randomWord.ruby || randomWord.meaning);
                usedMeanings.add(randomWord.meaning);
                sameCategoryWords.splice(randomIndex, 1);
            }
        }
        while (wrongAnswers.length < 3 && window.words.length > 1) {
            const randomWord = window.words[Math.floor(Math.random() * window.words.length)];
            if (!usedMeanings.has(randomWord.meaning)) {
                wrongAnswers.push(randomWord.ruby || randomWord.meaning);
                usedMeanings.add(randomWord.meaning);
            }
        }
        const answers = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5);

        $('#quizContainer').empty();
        const icon = question.icon || defaultIcons[question.category] || 'fas fa-question';
        const iconStyle = question.color ? `style="color: ${question.color}"` : '';
        $('#quizContainer').append(`
            <div class="question-card" data-word="${question.word}">
                <div class="text-center">
                    <i class="vocab-icon ${icon}" ${iconStyle} data-word="${question.word}"></i>
                    <i class="fas fa-volume-up sound-icon ms-2" data-word="${question.word}"></i>
                    <h4>${question.word}</h4>
                </div>
            </div>
            <div class="answer-grid">
                ${answers.map(answer => `
                    <div class="answer-card" data-answer="${answer}">
                        ${answer}
                    </div>
                `).join('')}
            </div>
            <div class="text-center mt-3" id="nextQuestionContainer" style="display: none;">
                <button id="nextQuestionButton" class="btn btn-primary btn-lg">
                    <i class="fas fa-arrow-right me-2"></i>Ê¨°„Å∏ÔºÅ
                </button>
            </div>
        `);
        console.log('„Ç¢„Ç§„Ç≥„É≥ÁîüÊàêÁ¢∫Ë™ç:', $('.vocab-icon').length, $('.vocab-icon').data('word'));
    }

    function bindEvents() {
        console.log('„Ç§„Éô„É≥„Éà„Éê„Ç§„É≥„ÉâÈñãÂßã');
        $(document).off('click touchstart', '.answer-card');
        $(document).off('click touchstart', '.vocab-icon');
        $(document).off('click touchstart', '.sound-icon');
        $(document).off('click', '#testSpeechButton');
        $(document).off('click', '#nextQuestionButton');

        $(document).on('click touchstart', '.answer-card', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ÂõûÁ≠îÈÅ∏Êäû:', $(this).data('answer'));
            if (!window.audioContext) initAudioContext();
            const selectedAnswer = $(this).data('answer');
            const correctAnswer = window.words[currentQuestion].ruby || window.words[currentQuestion].meaning;
            const $card = $(this);

            $('.answer-card').off('click touchstart');

            if (selectedAnswer === correctAnswer) {
                score++;
                correctInCurrentSet++;
                $card.addClass('correct');
                playCorrectSound();
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                $('#feedbackModalLabel').text('Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅüéâ');
                $('#feedbackModalBody').html(`"${window.words[currentQuestion].word}" „ÅØ "${correctAnswer}" „Åß„ÅôÔºÅ`);
                $('#feedbackModal').modal('show');
            } else {
                $card.addClass('incorrect');
                playIncorrectSound();
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                $('#feedbackModalLabel').text('„Åä„Å£„Å®ÔºÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶ÔºÅüòâ');
                $('#feedbackModalBody').html(`"${window.words[currentQuestion].word}" „ÅØ "${correctAnswer}" „Åß„Åô„ÄÅ"${selectedAnswer}" „Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºÅ`);
                $('#feedbackModal').modal('show');
                correctInCurrentSet = 0;
            }

            updateProgress();
        });

        $(document).on('click touchstart', '.vocab-icon', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (Date.now() - lastClick < 100) return;
            lastClick = Date.now();
            console.log('„Ç¢„Ç§„Ç≥„É≥„Çø„ÉÉ„ÉóÊ§úÁü•');
            const word = $(this).data('word');
            console.log('„Çø„ÉÉ„Éó„Åï„Çå„ÅüÂçòË™û:', word, 'speechEnabled:', window.speechEnabled, 'speechSynthesis:', !!window.speechSynthesis);
            $(this).addClass('vocab-icon-spin');
            setTimeout(() => $(this).removeClass('vocab-icon-spin'), 500);
            speakWord(word, 'vocab-icon', 'en-GB');
        });

        $(document).on('click touchstart', '.sound-icon', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (Date.now() - lastClick < 100) return;
            lastClick = Date.now();
            console.log('Èü≥Â£∞„Éú„Çø„É≥„Çø„ÉÉ„Éó');
            const word = $(this).data('word');
            console.log('„Çø„ÉÉ„Éó„Åï„Çå„ÅüÂçòË™û:', word, 'speechEnabled:', window.speechEnabled, 'speechSynthesis:', !!window.speechSynthesis);
            speakWord(word, 'sound-icon', 'en-GB');
        });

        $(document).on('click', '#testSpeechButton', function(e) {
            e.preventDefault();
            console.log('Èü≥Â£∞„ÉÜ„Çπ„Éà„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ');
            speakWord('Hello, welcome to the quiz', 'test-button', 'en-GB');
            showToast('Èü≥Â£∞„ÉÜ„Çπ„Éà„ÇíÂÆüË°å‰∏≠: en-GB', 'info');
        });

        $(document).on('click', '#nextQuestionButton', function(e) {
            e.preventDefault();
            console.log('Ê¨°„ÅÆÂïèÈ°å„Å∏„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ');
            $('#nextQuestionContainer').hide();
            handleNextQuestion();
        });

        $('#feedbackModal').on('hidden.bs.modal', function() {
            console.log('„É¢„Éº„ÉÄ„É´Èñâ„ÅòÊ§úÁü•');
            $('#nextQuestionContainer').show();
            document.activeElement.blur();
        });
    }

    $('#feedbackModal .btn-primary').on('click', function() {
        console.log('„É¢„Éº„ÉÄ„É´OK„ÇØ„É™„ÉÉ„ÇØ');
        $('#feedbackModal').modal('hide');
        $('#nextQuestionContainer').hide();
        handleNextQuestion();
    });

    function handleNextQuestion() {
        currentQuestion++;
        checkSetProgress();
        checkLevelUp();
        generateQuestion();
        bindEvents();
    }

    function checkSetProgress() {
        const setQuestionIndex = currentQuestion % QUESTIONS_PER_SET;
        if (setQuestionIndex === 0 && currentQuestion > 0) {
            if (correctInCurrentSet === QUESTIONS_PER_SET) {
                score += 2;
                showToast(`„Çª„ÉÉ„Éà${currentSet} „ÇØ„É™„Ç¢ÔºÅ„Éú„Éº„Éä„Çπ +2ÁÇπÔºÅ`, 'success');
                $('#feedbackModalLabel').text(`„Çª„ÉÉ„Éà${currentSet} „ÇØ„É™„Ç¢ÔºÅüéâ`);
                $('#feedbackModalBody').html(`5ÂïèÈÄ£Á∂öÊ≠£Ëß£ÔºÅÊ¨°„ÅÆ„Çª„ÉÉ„Éà${currentSet + 1}„Å∏ÈÄ≤„Åø„Åæ„ÅôÔºÅ`);
                $('#feedbackModal').modal('show');
                currentSet++;
                correctInCurrentSet = 0;
            } else {
                showToast(`„Çª„ÉÉ„Éà${currentSet} ÁµÇ‰∫Ü„ÄÇ${correctInCurrentSet}ÂïèÊ≠£Ëß£„Åß„Åó„Åü„ÄÇÊ¨°„ÅÆ„Çª„ÉÉ„Éà„Å∏ÔºÅ`, 'info');
                correctInCurrentSet = 0;
                currentSet++;
            }
            updateProgress();
        }
    }

    function checkLevelUp() {
        const newLevel = Math.floor(score / 5) + 1;
        if (newLevel > currentLevel) {
            currentLevel = newLevel;
            showToast(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅLevel ${currentLevel} ÈÅîÊàêÔºÅüéâ`, 'success');
            $('#feedbackModalLabel').text(`Level Up! üéâ`);
            $('#feedbackModalBody').html(`„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅLevel ${currentLevel} „Å´Âà∞ÈÅî„Åó„Åæ„Åó„ÅüÔºÅÊ¨°„ÅÆÊåëÊà¶„Å∏ÔºÅ`);
            $('#feedbackModal').modal('show');
            const bgClasses = ['bg-color', 'bg-fruit', 'bg-animal', 'bg-weather', 'bg-number'];
            const bgClass = bgClasses[(currentLevel - 1) % bgClasses.length];
            $('body').removeClass(bgClasses.join(' ')).addClass(bgClass);
        }
        $('#scoreText').text(`Ê≠£Ëß£: ${score}/${totalQuestions} (Level ${currentLevel}, „Çª„ÉÉ„Éà${currentSet})`);
    }

    function updateProgress() {
        totalQuestions = currentQuestion + 1;
        const progress = (totalQuestions / window.words.length) * 100;
        $('#progressBar').css('width', progress + '%').attr('aria-valuenow', progress);
        $('#scoreText').text(`Ê≠£Ëß£: ${score}/${totalQuestions} (Level ${currentLevel}, „Çª„ÉÉ„Éà${currentSet})`);
    }

    $('#resetButton').on('click', function() {
        console.log('„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ');
        if (!window.audioContext) initAudioContext();
        currentQuestion = 0;
        score = 0;
        totalQuestions = 0;
        currentLevel = 1;
        currentSet = 1;
        correctInCurrentSet = 0;
        window.words.sort(() => Math.random() - 0.5);
        updateProgress();
        generateQuestion();
        bindEvents();
    });

    $('#toggleSpeechButton').on('click', function() {
        console.log('Èü≥Â£∞„Éà„Ç∞„É´„ÇØ„É™„ÉÉ„ÇØ');
        window.speechEnabled = !window.speechEnabled;
        $(this).text(window.speechEnabled ? 'Èü≥Â£∞„Ç™„Éï' : 'Èü≥Â£∞„Ç™„É≥');
        showToast(window.speechEnabled ? 'Èü≥Â£∞„Çí„Ç™„É≥„Å´„Åó„Åæ„Åó„Åü' : 'Èü≥Â£∞„Çí„Ç™„Éï„Å´„Åó„Åæ„Åó„Åü', 'info');
    });

    function initializePage() {
        console.log('„Éö„Éº„Ç∏ÂàùÊúüÂåñÈñãÂßã');
        $('#quizContainer').html('<div class="text-center"><p>„ÇØ„Ç§„Ç∫„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p></div>');
        $('#toggleSpeechButton').text(window.speechEnabled ? 'Èü≥Â£∞„Ç™„Éï' : 'Èü≥Â£∞„Ç™„É≥');
        if (!window.audioContext) initAudioContext();
        waitForVoices().then(() => {
            console.log('Èü≥Â£∞ÂàùÊúüÂåñÂÆå‰∫Ü');
            const selectedVoice = speechSynthesis.getVoices().find(v => v.lang === 'en-GB' && v.name.includes('Google')) || 
                                 speechSynthesis.getVoices().find(v => v.lang === 'en-US' && v.name.includes('Google')) ||
                                 speechSynthesis.getVoices().find(v => v.lang === 'en-GB') ||
                                 speechSynthesis.getVoices().find(v => v.lang === 'en-US') || 
                                 speechSynthesis.getVoices()[0];
            console.log('ÈÅ∏Êäû„Åï„Çå„ÅüÈü≥Â£∞:', selectedVoice ? `${selectedVoice.name} (${selectedVoice.lang})` : '„Å™„Åó');
            if (!selectedVoice) {
                showToast('Èü≥Â£∞„ÅåÂÜçÁîü„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÈü≥Â£∞„Éú„Çø„É≥„Çí„Ç™„Éï„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
            } else if (!selectedVoice.name.includes('Google') && selectedVoice.lang !== 'en-GB') {
                showToast('en-GBÈü≥Â£∞„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ' + selectedVoice.lang + '„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ', 'warning');
            }
            generateQuestion();
            bindEvents();
        }).catch(err => {
            console.error('Èü≥Â£∞ÂàùÊúüÂåñ„Ç®„É©„Éº:', err);
            showToast('Èü≥Â£∞„ÅåÂÜçÁîü„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÈü≥Â£∞„Éú„Çø„É≥„Çí„Ç™„Éï„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
            generateQuestion();
            bindEvents();
        });
    }

    loadData(initializePage);
    console.log('quiz.js „É≠„Éº„ÉâÂÆå‰∫Ü');
});